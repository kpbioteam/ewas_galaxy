<tool id="minfi_read450k" name="Minfi Read 450k" version="2.1.0">
    <description>load .IDAT files</description>
    <requirements>
        <requirement type="package" version="1.24.0">bioconductor-minfi</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[

import os

# detect the current working directory
path = os.getcwd($files_red)

# read the entries
with os.scandir(path) as listOfEntries:  
    for entry in listOfEntries:
        # print all entries that are files
        if entry.is_file():
            print(entry.name)

      cat '$read_idat_script' &&
      Rscript '$read_idat_script'
      ]]></command>
      <configfiles>
      <configfile name="read_idat_script"><![CDATA[
        require("minfi", quietly = TRUE)

        out <- read.metharray(entry.name)

        save(out, file = '$RGChannelSet')
        ]]> </configfile>
        </configfiles>
        <inputs>
            <!-- Counts and Factors -->
        <conditional name="input">
            <param name="format" type="select" label="Count Files or Matrix?"
                help="You can choose to input either separate count files (one per sample) or a single count matrix">
                <option value="files">Separate Count Files</option>
                <option value="matrix">Single Count Matrix</option>
            </param>

            <when value="files">
                <repeat name="rep_factor" title="Factor" min="1">
                    <param name="factorName" type="text" label="Name" help="Name of experiment factor of interest (e.g. Genotype). One factor must be entered and there must be two or more groups per factor. Optional additional factors (e.g. Batch) can be entered using the Insert Factor button below, see Help section for more information. NOTE: Please only use letters, numbers or underscores.">
                    <sanitizer>
                        <valid initial="string.letters,string.digits"><add value="_" /></valid>
                    </sanitizer>
                    </param>
                    <repeat name="rep_group" title="Group" min="2" default="2">
                        <param name="groupName" type="text" label="Name"
                        help="Name of group that the counts files belong to (e.g. WT or Mut). NOTE: Please only use letters, numbers or underscores (case sensitive).">
                        <sanitizer>
                            <valid initial="string.letters,string.digits"><add value="_" /></valid>
                        </sanitizer>
                        </param>
                        <param name="idatsFile" type="data" format="tabular" multiple="true" label="Counts files"/>
                    </repeat>
                </repeat>
            </when>

            <when value="matrix">
                <param name="counts" type="data" format="tabular" label="Count Matrix"/>

                <conditional name="fact">
                    <param name="ffile" type="select" label="Input factor information from file?"
                        help="You can choose to input the factor and group information for the samples from a file or manually enter below. NOTE: Please only use letters, numbers or underscores (case sensitive), the group names MUST not contain hyphens.">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </param>
                    <when value="yes">
                        <param name="finfo" type="data" format="tabular" label="Factor File"/>
                    </when>
                    <when value="no" >
                        <repeat name="rep_factor" title="Factor" min="1">
                            <param name="factorName" type="text" label="Factor Name"
                                help="Name of experiment factor of interest (e.g. Genotype). One factor must be entered and there must be two or more groups per factor. Additional factors (e.g. Batch) can be entered using the Insert Factor button below, see Help section below. NOTE: Please only use letters, numbers or underscores.">
                                <validator type="empty_field" />
                                <validator type="regex" message="Please only use letters, numbers or underscores">^[\w]+$</validator>
                            </param>
                            <param name="groupNames" type="text" label="Groups"
                                help="Enter the group names for the samples separated with commas e.g. WT,WT,WT,Mut,Mut,Mut. The order of the names must match the order of the samples in the columns of the count matrix. NOTE: Please only use letters, numbers or underscores (case sensitive), the group names MUST not contain hyphens.">
                                <validator type="empty_field" />
                                <validator type="regex" message="Please only use letters, numbers or underscores, and separate levels by commas">^[\w,]+$</validator>
                            </param>
                        </repeat>
                    </when>
                </conditional>
            </when>
        </conditional>
            </inputs>
            <outputs>
            <data name="RGChannelSet" format="rdata" label="RGChannelSet"/>
              </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="format" value="files" />
            <repeat name="rep_factor">
                <param name="factorName" value="Sensitivity"/>
                <repeat name="rep_group">
                    <param name="groupName" value="sensitive"/>
                    <param name="idatsFile" value="GSM1588704_8795207135_R01C02_Red.idat, GSM1588704_8795207135_R01C02_Grn.idat
                    GSM1588705_8795207119_R05C02_Red.idat, GSM1588705_8795207119_R05C02_Grn.idat"/>
                </repeat>
                <repeat name="rep_group">
                    <param name="groupName" value="resistant"/>
                    <param name="idatsFile" value="GSM1588706_8795207135_R02C02_Red.idat, GSM1588706_8795207135_R02C02_Grn.idat
                    GSM1588707_8795207119_R06C02_Red.idat, GSM1588707_8795207119_R06C02_Grn.idat"/>
                </repeat>
            </repeat>
            <repeat name="rep_factor">
                <param name="factorName" value="Treatment"/>
                <repeat name="rep_group">
                    <param name="groupName" value="MAPKi"/>
                    <param name="idatsFile" value="GSM1588704_8795207135_R01C02_Red.idat, GSM1588704_8795207135_R01C02_Grn.idat
                    GSM1588705_8795207119_R05C02_Red.idat, GSM1588705_8795207119_R05C02_Grn.idat"/>
                </repeat>
                <repeat name="rep_group">
                    <param name="groupName" value="BRAFi"/>
                    <param name="idatsFile" value="GSM1588706_8795207135_R02C02_Red.idat, GSM1588706_8795207135_R02C02_Grn.idat
                    GSM1588707_8795207119_R06C02_Red.idat, GSM1588707_8795207119_R06C02_Grn.idat"/>
                </repeat>
            <output name="RGChannelSet" file="RGChannelSet.rdata"/>
            </output>
        
        </test>
    </tests>

    <help><![CDATA[
.. class:: infomark

**What it does**

The tool load the binary 450K array “IDAT” raw files generated by the Illumina Scanner. In addition to the methylated and an unmethylated intensity values for each 450,000 CpG positions, IDAT file contains some extra info such as control probes.

-----

**Input Data:**
The counts data can either be input as separate counts files (one sample per file) or a single count matrix (one sample per column). The rows correspond to genes, and columns correspond to the counts for the samples. Values must be tab separated, with the first row containing the sample/column labels and the first column containing the row/gene labels. The sample labels must start with a letter. Gene identifiers can be of any type but must be unique and not repeated within a counts file.

Example - **Separate Idats Files**:

GSM1588707_8795207119_R06C02_Red.idat,GSM1588706_8795207135_R02C02_Red.idat,GSM1588705_8795207119_R05C02_Red.idat,GSM1588704_8795207135_R01C02_Red.idat

Example - **Single Idat Matrix**:

    ========================= ====================== ======================== 
          **File Name**          **Sensitivity**          **Treatment** 
    ------------------------- ---------------------- ------------------------ 

    ========================= ====================== ======================== 

    ]]></help>
    <citations>
         <citation type="doi">10.18129/B9.bioc.illuminaio</citation>
    </citations>
</tool>
